<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>QR ì¸ì‹ Â· 8ìë¦¬ ê²€ì‚¬</title>
  <style>
    :root{ --bg:#0b0f14; --fg:#f5f7fa; --muted:#9aa4b2; --accent:#4c9fff; --danger:#ff5566; --ok:#24d27e; --card:#11161d; --border:#1d2430; }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,Helvetica,Arial,sans-serif;}
    header{padding:16px; text-align:center; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#0d141d,#0b0f14); position:sticky; top:0; z-index:10;}
    header h1{margin:0; font-size:18px; letter-spacing:.2px}
    main{padding:16px; max-width:700px; margin:0 auto}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.25);}
    .preview{position:relative; aspect-ratio:9/16; width:100%; background:#000;}
    video{width:100%; height:100%; object-fit:cover; display:block; background:#000;}
    .overlay{position:absolute; inset:0; pointer-events:none; display:flex; align-items:center; justify-content:center;}
    .frame{width:70%; aspect-ratio:1/1; border:2px dashed rgba(255,255,255,.35); border-radius:12px; box-shadow:inset 0 0 0 9999px rgba(0,0,0,.25); backdrop-filter:blur(2px);}
    .controls{display:flex; gap:12px; padding:12px; border-top:1px solid var(--border); flex-wrap:wrap; align-items:center; justify-content:center;}
    button{flex:1 1 auto; min-width:120px; padding:14px 16px; border-radius:12px; border:1px solid var(--border); background:#131a23; color:var(--fg); font-size:16px; font-weight:600; cursor:pointer; transition:.15s ease; touch-action:manipulation;}
    button:hover{transform:translateY(-1px)}
    .on{background:var(--accent); color:#041423; border-color:transparent}
    .off{background:#1b2330}
    .muted{color:var(--muted); font-size:13px; text-align:center; padding:8px 12px 14px}
    .row{display:flex; gap:12px; align-items:center; justify-content:center; padding:0 12px 12px; flex-wrap:wrap}
    select{appearance:none; background:#0f141c; color:var(--fg); border:1px solid var(--border); border-radius:10px; padding:12px 14px; min-width:220px; font-size:14px; flex:1 1 220px;}
    .chip{font-size:12px; color:var(--muted)}
    .stat{padding:12px; border-top:1px solid var(--border); display:flex; gap:12px; flex-wrap:wrap; justify-content:space-between; align-items:center;}
    .tag{padding:6px 10px; border-radius:999px; background:#0f1722; border:1px solid var(--border); font-size:12px; color:var(--muted)}
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:1000;}
    .modal{width:min(500px,90vw); background:var(--card); border:1px solid var(--border); border-radius:16px; padding:24px 20px; box-shadow:0 20px 60px rgba(0,0,0,.5); animation:pop .15s ease-out; text-align:center;}
    @keyframes pop{from{transform:scale(.96); opacity:0} to{transform:scale(1); opacity:1}}
    .modal h3{margin:0 0 6px; font-size:18px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; background:#0e1420; border:1px solid var(--border); border-radius:8px; padding:4px 8px;}
    .yes{color:var(--ok)} .no{color:var(--danger)}
    .modal .actions{display:flex; gap:10px; margin-top:14px} .modal .actions button{flex:1 1 auto}
    .auto-close-hint{font-size:12px; color:var(--muted); text-align:right}
    .hidden{display:none}
    /* ìƒˆ ëª¨ë‹¬ ë””ìì¸ */
    .student-id{font-size:22px; font-weight:800; margin:10px 0 14px; color:var(--accent);}
    .student-id .kbd{font-size:24px; padding:6px 10px;}
    .pay-status{font-size:32px; font-weight:900; margin:10px 0 6px;}
    .pay-emoji{font-size:40px; line-height:1; margin-top:2px;}
    @media (max-width:480px){header h1{font-size:16px} button{font-size:15px; padding:12px 14px} .pay-status{font-size:28px}}
  </style>
</head>
<body>
  <header><h1>QR ì¸ì‹ â†’ ì• 8ìë¦¬ ìˆ«ì ê²€ì‚¬</h1></header>

  <main>
    <section class="card">
      <div class="preview">
        <video id="video" playsinline muted></video>
        <div class="overlay"><div class="frame" aria-hidden="true"></div></div>
      </div>

      <div class="controls">
        <button id="toggleBtn" class="off" type="button">ì¹´ë©”ë¼ ì¼œê¸°</button>
        <button id="flashBtn" type="button" title="ì¼ë¶€ ê¸°ê¸°ë§Œ ì§€ì›" disabled>í”Œë˜ì‹œ</button>
      </div>

      <div class="row">
        <select id="deviceSelect" title="PCì—ì„œëŠ” 0ë²ˆ ìº (ì²« ë²ˆì§¸) ìë™ ì„ íƒ">
          <option value="">ì¹´ë©”ë¼ ì„ íƒ(ìë™)</option>
        </select>
        <span class="chip">ëª¨ë°”ì¼: í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ </span>
      </div>

      <!-- ì—‘ì…€ ê´€ë ¨ UI -->
      <div class="row">
        <button id="pickExcelBtn" type="button">ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°(ë¡œì»¬ Â· Gì—´)</button>
        <button id="dumpBtn" type="button">ë°ì´í„° í™•ì¸(ì½˜ì†”)</button>
        <button id="clearDataBtn" type="button" title="ì´ ì‚¬ì´íŠ¸ì˜ ë¡œì»¬ ì €ì¥Â·ì¿ í‚¤Â·ìºì‹œ ì‚­ì œ">ì¿ í‚¤/ìºì‹œ ì‚­ì œ</button>
        <span id="excelStatus" class="chip">ì—‘ì…€ ë¯¸ë¡œë”©</span>
      </div>

      <div class="stat">
        <span class="tag" id="lastRaw">ë§ˆì§€ë§‰ ì›ë³¸: -</span>
        <span class="tag" id="lastTrim">ì• 8ìë¦¬: -</span>
      </div>

      <div id="diag" class="muted">https í™˜ê²½ì—ì„œ ê¶Œí•œ í—ˆìš© í›„ ì‚¬ìš©í•˜ì„¸ìš”.</div>
    </section>
  </main>

  <!-- ìƒˆ ëª¨ë‹¬: ì›ë³¸ ë°ì´í„°(ë¬¸ìì—´) í‘œì‹œëŠ” ì œê±°, í•™ë²ˆ+ë‚©ë¶€ì—¬ë¶€ë§Œ í¼ì§í•˜ê²Œ -->
  <div id="backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <h3 id="modalTitle">í™•ì¸ ê²°ê³¼</h3>

      <div class="student-id">
        í•™ë²ˆ ğŸ“ <span id="modalFirst8" class="kbd">-</span>
      </div>

      <div class="pay-emoji" id="modalEmoji" aria-hidden="true">âŒ</div>
      <div class="pay-status no" id="modalState">ë¯¸ë‚©ë¶€</div>

      <div class="actions"><button id="closeModal" type="button">ë‹«ê¸°</button></div>
      <div class="auto-close-hint" id="autoHint">2ì´ˆ í›„ ìë™ ë‹«í˜</div>
    </div>
  </div>

  <!-- jsQR (í´ë°±) -->
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <!-- xlsx(SheetJS) : ë¡œì»¬ íŒŒì‹± -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
  // ===================== ì„¤ì •/ìƒìˆ˜ =====================
  let TARGET_VALUES = [];                // ì €ì¥ìš© ë°°ì—´(ë””ë²„ê·¸/í‘œì‹œìš©)
  let TARGET_SET = new Set();            // ë¹„êµëŠ” Setìœ¼ë¡œ (íƒ€ì… ë¬¸ì œ ì œê±°)
  const DEBOUNCE_MS = 1200;
  const STORAGE_KEY = 'qr_target_values_v1';
  const STORAGE_META_KEY = 'qr_target_meta_v1';
  // ê°œë°œ í¸ì˜: ì½˜ì†”ì—ì„œ window.__qrDebug.values / .set ìœ¼ë¡œ í™•ì¸ ê°€ëŠ¥
  window.__qrDebug = { get values(){ return TARGET_VALUES }, get set(){ return TARGET_SET } };
  // ====================================================

  const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  const video = document.getElementById('video');
  const toggleBtn = document.getElementById('toggleBtn');
  const deviceSelect = document.getElementById('deviceSelect');
  const flashBtn = document.getElementById('flashBtn');
  const lastRawEl = document.getElementById('lastRaw');
  const lastTrimEl = document.getElementById('lastTrim');
  const diag = document.getElementById('diag');

  const backdrop = document.getElementById('backdrop');
  const modalFirst8 = document.getElementById('modalFirst8');
  const modalState = document.getElementById('modalState');
  const modalEmoji = document.getElementById('modalEmoji');
  const closeModalBtn = document.getElementById('closeModal');
  const autoHint = document.getElementById('autoHint');

  const pickExcelBtn = document.getElementById('pickExcelBtn');
  const clearDataBtn = document.getElementById('clearDataBtn');
  const dumpBtn = document.getElementById('dumpBtn');
  const excelStatus = document.getElementById('excelStatus');

  const excelInput = document.createElement('input');
  excelInput.type = 'file';
  excelInput.accept = '.xlsx,.xls';
  excelInput.style.display = 'none';
  document.body.appendChild(excelInput);

  let stream = null, scanning = false, scanLoopId = null;
  let lastShown = { value: null, time: 0 };
  let autoCloseTimer = null, trackForTorch = null;

  const barcodeDetectorSupported = ('BarcodeDetector' in window);
  const detector = barcodeDetectorSupported ? new BarcodeDetector({ formats: ['qr_code'] }) : null;

  function logDiag(msg){ console.log(msg); if(diag) diag.textContent = String(msg); }

  // ---------- ìˆ«ì ì •ê·œí™” & 8ìë¦¬ ë³€í™˜ ----------
  function normalizeDigits(input){
    let s = String(input ?? '');
    s = s.replace(/[\uFF10-\uFF19]/g, ch => String.fromCharCode(ch.charCodeAt(0)-0xFF10+0x30)); // ì „ê°
    s = s.replace(/[\u0660-\u0669]/g, ch => String.fromCharCode(ch.charCodeAt(0)-0x0660+0x30)); // Arabic-Indic
    s = s.replace(/[\u06F0-\u06F9]/g, ch => String.fromCharCode(ch.charCodeAt(0)-0x06F0+0x30)); // Ext Arabic-Indic
    return s;
  }
  function first8FromCell(cell){
    if (typeof cell === 'number' && Number.isFinite(cell)) {
      const digits = Math.trunc(cell).toString();
      return digits.padStart(8, '0').slice(0, 8);
    }
    const s = normalizeDigits(cell);
    const digits = s.replace(/\D/g, '');
    if (digits.length >= 8) return digits.slice(0, 8);
    if (digits.length > 0)  return digits.padStart(8, '0');
    return '';
  }
  function extractFirst8Digits(str){
    const s = normalizeDigits(str);
    const digits = s.replace(/\D/g,'');
    return digits.slice(0,8);
  }

  // ---------- Local persistence ----------
  function saveTargetValuesToStorage(values, meta = {}) {
    try {
      const coerced = values
        .map(v => String(v ?? ''))
        .map(s => s.replace(/\D/g, '').slice(0, 8))
        .map(s => (s.length === 8 ? s : s.padStart(8, '0')))
        .filter(s => s.length === 8);

      const uniq = Array.from(new Set(coerced));
      localStorage.setItem(STORAGE_KEY, JSON.stringify(uniq));
      localStorage.setItem(
        STORAGE_META_KEY,
        JSON.stringify({ ...meta, count: uniq.length, savedAt: new Date().toISOString() })
      );

      TARGET_VALUES = uniq;
      TARGET_SET = new Set(uniq);
      excelStatus.textContent = `ì—‘ì…€ ë¡œë”© ì™„ë£Œ Â· ${uniq.length}ê±´`;
      console.log('[SAVE] TARGET_VALUES length =', uniq.length, 'sample =', uniq.slice(0, 10));
    } catch (e) {
      alert('ë¡œì»¬ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤(ìš©ëŸ‰/ê¶Œí•œ í™•ì¸).'); console.error(e);
    }
  }

  function loadTargetValuesFromStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      const metaRaw = localStorage.getItem(STORAGE_META_KEY);
      if (!raw) {
        excelStatus.textContent = 'ì—‘ì…€ ë¯¸ë¡œë”©';
        TARGET_VALUES = []; TARGET_SET = new Set();
        console.log('[LOAD] no saved data');
        return;
      }

      const arr = JSON.parse(raw) || [];
      const fixed = arr
        .map(v => String(v ?? ''))
        .map(s => s.replace(/\D/g, '').padStart(8, '0').slice(0, 8))
        .filter(s => s.length === 8);

      TARGET_VALUES = fixed;
      TARGET_SET = new Set(fixed);

      const meta = metaRaw ? JSON.parse(metaRaw) : {};
      excelStatus.textContent = meta.fileName
        ? `ì €ì¥ê°’ ì‚¬ìš©(${meta.fileName}) Â· ${fixed.length}ê±´`
        : `ì €ì¥ê°’ ì‚¬ìš© Â· ${fixed.length}ê±´`;

      console.log('[LOAD] TARGET_VALUES length =', fixed.length, 'sample =', fixed.slice(0, 10));
    } catch (e) {
      console.warn('ì €ì¥ê°’ ë³µì› ì‹¤íŒ¨', e);
      excelStatus.textContent = 'ì €ì¥ê°’ ë³µì› ì‹¤íŒ¨';
      TARGET_VALUES = []; TARGET_SET = new Set();
    }
  }

  async function clearSiteData(){
    try{
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(STORAGE_META_KEY);

      const cookies = document.cookie.split(';');
      for(const c of cookies){
        const eq = c.indexOf('=');
        const name = (eq>-1 ? c.substr(0,eq) : c).trim();
        document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;
        const parts = location.hostname.split('.');
        for(let i=0;i<parts.length-1;i++){
          const domain='.'+parts.slice(i).join('.');
          document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; domain=${domain}`;
        }
      }
      if('caches' in window){ const keys = await caches.keys(); await Promise.all(keys.map(k=>caches.delete(k))); }
      if('serviceWorker' in navigator){ const regs=await navigator.serviceWorker.getRegistrations(); await Promise.all(regs.map(r=>r.unregister())); }

      TARGET_VALUES=[]; TARGET_SET=new Set();
      excelStatus.textContent='ì‚¬ì´íŠ¸ ë°ì´í„° ì‚­ì œ ì™„ë£Œ Â· ì—‘ì…€ ë¯¸ë¡œë”©';
      logDiag('ì‚¬ì´íŠ¸ ë°ì´í„°(ë¡œì»¬ ì €ì¥/ì¿ í‚¤/ìºì‹œ/SW) ì‚­ì œ ì™„ë£Œ');
      alert('ì¿ í‚¤/ìºì‹œ/ë¡œì»¬ ì €ì¥ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.');
    }catch(e){ console.error(e); alert('ì‚¬ì´íŠ¸ ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
  }

  // ---------- Excel(Gì—´) ë¡œë”© (ì‹œíŠ¸ ìë™íƒìƒ‰ + Gì—´ ì§ì ‘ì½ê¸°) ----------
  async function loadExcelFromFile(file){
    if(!file){ excelStatus.textContent='ì—‘ì…€ ì„ íƒ ì·¨ì†Œ'; return; }
    try{
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, { type: 'array' });

      // 1) ëª¨ë“  ì‹œíŠ¸ë¥¼ ëŒë©´ì„œ "Gì—´ì—ì„œ ë½‘íŒ ê±´ìˆ˜"ê°€ ê°€ì¥ ë§ì€ ì‹œíŠ¸ë¥¼ ì„ íƒ
      function readGFromSheet(ws){
        const out = [];
        const ref = ws['!ref'];
        if(!ref) return out;

        const range = XLSX.utils.decode_range(ref); // {s:{r,c}, e:{r,c}}
        // Gì—´(0-based 6)ë§Œ ìˆœíšŒ
        const G = 6;
        for(let r = range.s.r; r <= range.e.r; r++){
          const addr = XLSX.utils.encode_cell({ r, c: G }); // "G{row}"
          const cell = ws[addr]?.v; // ì›ì‹œ ê°’
          const f8 = first8FromCell(cell);
          if(f8) out.push(f8);
        }
        return out;
      }

      const sheetStats = wb.SheetNames.map(name=>{
        const ws = wb.Sheets[name];
        const vals = readGFromSheet(ws);
        return { name, count: vals.length, vals };
      });

      // ê±´ìˆ˜ê°€ ê°€ì¥ í° ì‹œíŠ¸ ì„ íƒ
      sheetStats.sort((a,b)=> b.count - a.count);
      const best = sheetStats[0];
      console.log('[EXCEL] ì‹œíŠ¸ë³„ Gì—´ ê±´ìˆ˜:', sheetStats.map(s=>({name:s.name, count:s.count})));

      if(!best || best.count === 0){
        excelStatus.textContent = 'Gì—´ì—ì„œ ìœ íš¨í•œ 8ìë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤';
        console.warn('[EXCEL] ëª¨ë“  ì‹œíŠ¸ì—ì„œ Gì—´ ì¶”ì¶œ 0ê±´');
        saveTargetValuesToStorage([], { fileName: file.name, sheet: best?.name || '(none)' });
        return;
      }

      // 2) ìµœì  ì‹œíŠ¸ì˜ ê°’ ì €ì¥
      saveTargetValuesToStorage(best.vals, { fileName: file.name, sheet: best.name });
      console.log('[EXCEL] ì„ íƒ ì‹œíŠ¸:', best.name, 'ê±´ìˆ˜:', best.count, 'ì˜ˆì‹œ:', best.vals.slice(0,10));

    }catch(err){
      excelStatus.textContent = 'ì—‘ì…€ ë¡œë”© ì‹¤íŒ¨';
      console.error('ì—‘ì…€ íŒŒì‹± ì—ëŸ¬:', err);
      alert('ì—‘ì…€ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }finally{
      excelInput.value = '';
    }
  }

  // ---------- UI ë°”ì¸ë”© ----------
  pickExcelBtn.addEventListener('click', ()=> excelInput.click());
  excelInput.addEventListener('change', (e)=> loadExcelFromFile(e.target.files?.[0]));
  clearDataBtn.addEventListener('click', clearSiteData);
  dumpBtn.addEventListener('click', ()=> {
    console.log('[DUMP] TARGET_VALUES length =', TARGET_VALUES.length, 'sample =', TARGET_VALUES.slice(0, 20));
    console.log('[DUMP] TARGET_SET size =', TARGET_SET.size);
  });

  // ---------- Camera ----------
  async function listCameras(){
    try{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d=>d.kind==='videoinput');
      deviceSelect.innerHTML = '<option value="">ì¹´ë©”ë¼ ì„ íƒ(ìë™)</option>';
      cams.forEach((cam,idx)=>{
        const opt = document.createElement('option');
        opt.value = cam.deviceId;
        opt.textContent = cam.label || `ì¹´ë©”ë¼ ${idx+1}`;
        deviceSelect.appendChild(opt);
      });
    }catch(e){ /* ê¶Œí•œ ì „ì—ëŠ” labelì´ ë¹„ì–´ìˆì„ ìˆ˜ ìˆìŒ */ }
  }
  function getPreferredConstraints(){
    if(isMobile){
      return { video: { facingMode: { ideal: 'environment' }, width:{ideal:1280}, height:{ideal:720} }, audio:false };
    }
    const selected = deviceSelect.value;
    if(selected){
      return { video: { deviceId: { exact: selected }, width:{ideal:1280}, height:{ideal:720} }, audio:false };
    }
    return { video: true, audio:false };
  }
  async function startCamera(){
    if(stream) await stopCamera();
    try{
      try{
        if (navigator.permissions && navigator.permissions.query){
          const perm = await navigator.permissions.query({ name: 'camera' });
          logDiag(`ì¹´ë©”ë¼ ê¶Œí•œ ìƒíƒœ: ${perm.state}`);
        }
      }catch(_){}

      await listCameras();

      if(!isMobile && !deviceSelect.value){
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cams = devices.filter(d=>d.kind==='videoinput');
        if(cams.length>0) deviceSelect.value = cams[0].deviceId;
      }

      const constraints = getPreferredConstraints();
      logDiag(`ìš”ì²­ ì œì•½: ${JSON.stringify(constraints)}`);

      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      await video.play();

      trackForTorch = stream.getVideoTracks()[0] || null;
      const cap = trackForTorch?.getCapabilities?.() || {};
      flashBtn.disabled = !cap.torch;

      scanning = true;
      toggleBtn.textContent = 'ì¹´ë©”ë¼ ë„ê¸°';
      toggleBtn.classList.remove('off'); toggleBtn.classList.add('on');

      logDiag('ì¹´ë©”ë¼ ì‹œì‘ ì„±ê³µ');
      runScanLoop();
    }catch(err){
      let tip = '';
      switch(err?.name){
        case 'NotAllowedError': tip='ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì¹´ë©”ë¼ í—ˆìš© í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.'; break;
        case 'NotFoundError': tip='ì¹´ë©”ë¼ ì¥ì¹˜ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì•± ì ìœ  ì—¬ë¶€ í™•ì¸.'; break;
        case 'OverconstrainedError': tip=`ì œì•½ ì¶©ëŒ: ${err?.constraint}`; break;
        default: tip='ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
      }
      logDiag(`ì‹œì‘ ì‹¤íŒ¨: ${err?.name || err} / ${tip}`);
      alert(`ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\n${err?.name || err}\n${tip}`);
      await stopCamera();
    }
  }
  async function stopCamera(){
    scanning = false;
    if(scanLoopId) cancelAnimationFrame(scanLoopId);
    scanLoopId = null;
    if(stream){
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }
    toggleBtn.textContent = 'ì¹´ë©”ë¼ ì¼œê¸°';
    toggleBtn.classList.remove('on'); toggleBtn.classList.add('off');
  }
  toggleBtn.addEventListener('click', ()=>{ if(scanning) stopCamera(); else startCamera(); });
  deviceSelect.addEventListener('change', ()=>{ if(scanning) startCamera(); });

  // í”Œë˜ì‹œ
  let torchOn = false;
  flashBtn.addEventListener('click', async ()=>{
    if(!trackForTorch) return;
    const cap = trackForTorch.getCapabilities?.() || {};
    if(!cap.torch) return;
    torchOn = !torchOn;
    try{
      await trackForTorch.applyConstraints({ advanced: [{ torch: torchOn }] });
      flashBtn.textContent = torchOn ? 'í”Œë˜ì‹œ ë„ê¸°' : 'í”Œë˜ì‹œ ì¼œê¸°';
    }catch(e){ console.warn('Torch error', e); }
  });

  // ìŠ¤ìº” ë£¨í”„ (BarcodeDetector â†’ jsQR í´ë°±)
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });

  async function runScanLoop(){
    const step = async ()=>{
      if(!scanning || video.readyState < 2){ scanLoopId = requestAnimationFrame(step); return; }
      try{
        const vw = video.videoWidth, vh = video.videoHeight;
        canvas.width = vw; canvas.height = vh;
        ctx.drawImage(video, 0, 0, vw, vh);

        let raw = null;

        if(detector){
          try{
            const bmp = await createImageBitmap(canvas);
            const codes = await detector.detect(bmp);
            bmp.close?.();
            if(codes && codes.length) raw = codes[0].rawValue || '';
          }catch(_){ /* í´ë°± */ }
        }

        if(!raw){
          if(typeof jsQR === 'function'){
            const imageData = ctx.getImageData(0, 0, vw, vh);
            const result = jsQR(imageData.data, vw, vh, { inversionAttempts: 'dontInvert' });
            if(result && result.data) raw = result.data;
          }else{
            const now = performance.now();
            if(now - lastShown.time > 1000 && backdrop.style.display !== 'flex'){
              showModal('jsQR ë¡œë”© ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬/ì°¨ë‹¨ í™•ì¸).', '', false, true);
              lastShown.time = now;
            }
          }
        }

        if(raw){ handleCode(raw); }
      }catch(e){ console.warn('detect error', e); }

      await new Promise(r=>setTimeout(r, 150));
      scanLoopId = requestAnimationFrame(step);
    };
    scanLoopId = requestAnimationFrame(step);
  }

  function handleCode(raw){
    // ì›ë³¸ ë¡œê·¸(í•„í„°ë§ ì—†ìŒ)
    console.log('QR ì¸ì‹(raw):', raw);

    const now = performance.now();
    if(lastShown.value === raw && (now - lastShown.time) < DEBOUNCE_MS) return;

    const first8 = extractFirst8Digits(raw);
    lastRawEl.textContent = 'ë§ˆì§€ë§‰ ì›ë³¸: ' + (raw || '-');
    lastTrimEl.textContent = 'ì• 8ìë¦¬: ' + (first8 || '-');

    const exists = first8 && TARGET_SET.has(first8);

    if (!exists) {
      console.log('[MISS] first8 =', first8, '| setSize =', TARGET_SET.size, '| sample =', TARGET_VALUES.slice(0,10));
    } else {
      console.log('[HIT] first8 =', first8);
    }

    showModal(raw, first8, !!exists);
    lastShown = { value: raw, time: now };
  }

  // ìƒˆ ëª¨ë‹¬ ë¡œì§: í•™ë²ˆ + ë‚©ë¶€ì—¬ë¶€ë§Œ í‘œì‹œ(ì´ëª¨ì§€ í¬í•¨)
  function showModal(raw, first8, exists, infoOnly=false){
    modalFirst8.textContent = first8 ? first8 : '-';

    if(infoOnly){
      modalEmoji.textContent = 'â„¹ï¸';
      modalState.textContent = 'ì •ë³´';
      modalState.classList.remove('yes'); modalState.classList.add('no');
    }else{
      if(exists){
        modalEmoji.textContent = 'âœ…';
        modalState.textContent = 'ë‚©ë¶€ ì™„ë£Œ';
        modalState.classList.remove('no'); modalState.classList.add('yes');
      }else{
        modalEmoji.textContent = 'âŒ';
        modalState.textContent = 'ë¯¸ë‚©ë¶€';
        modalState.classList.remove('yes'); modalState.classList.add('no');
      }
    }

    backdrop.style.display = 'flex';

    clearTimeout(autoCloseTimer);
    autoHint.textContent = '2ì´ˆ í›„ ìë™ ë‹«í˜';
    let start = Date.now();
    const tick = ()=>{
      const remain = 2000 - (Date.now() - start);
      if(remain <= 0) { closeModal(); return; }
      autoHint.textContent = Math.ceil(remain/1000) + 'ì´ˆ í›„ ìë™ ë‹«í˜';
      autoCloseTimer = setTimeout(tick, 200);
    };
    autoCloseTimer = setTimeout(tick, 200);
  }
  function closeModal(){ clearTimeout(autoCloseTimer); backdrop.style.display = 'none'; }
  closeModalBtn.addEventListener('click', closeModal);
  backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) closeModal(); });

  // ì´ˆê¸° ìƒíƒœ
  if(!('mediaDevices' in navigator) || !('getUserMedia' in navigator.mediaDevices)){
    alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ì¹´ë©”ë¼ ì‚¬ìš©ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
  }else{
    loadTargetValuesFromStorage(); // ì €ì¥ëœ ì—‘ì…€ ëª©ë¡ ë³µì›
    listCameras();                 // ê¶Œí•œ ì „ì—ëŠ” labelì´ ë¹ˆ ê°’ì¼ ìˆ˜ ìˆìŒ
  }
  document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ if(scanning) stopCamera(); }});
  </script>
</body>
</html>
